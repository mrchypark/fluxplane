---
title: "fluxplane"
author: "박찬엽"
date: "2024년 1월 20일"
output:
  xaringan::moon_reader:
    seal: false
    css: ["default", "ninjutsu", "custom.css"]
    lib_dir: libs
    # includes:
    #   in_header: google_analytics.html
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: '16:9'
---

class: center, middle, title-slide

# fluxplane
## crossplane과 flux로 구축하는 Infra as code 

### <https://mrchypark.github.io/fluxplane>

#### [[의견 및 오류 신고]](https://github.com/mrchypark/fluxplane/issues/new)

### 박찬엽 <mrhcypark@gmail.com>

### 2024년 1월 20일

---

class: center, middle, title-slide

# fluxplane
## ~~crossplane과 flux로 구축하는 Infra as code~~
## 본격 야믈러(yamler)의 길
### <https://mrchypark.github.io/fluxplane>

### 박찬엽 <mrhcypark@gmail.com>

### 2024년 1월 20일

---
class: split-50 

.column[.content.vmiddle.right[
    ![](https://avatars2.githubusercontent.com/u/6179259?v=4&s=460)
]]
.column[.content.left[
<br>
<br>
<br>
### 박찬엽     
- 초짜 CTO(@Conalog)
- `r icons::fontawesome$brands$youtube` 팟캐스트 데이터홀릭 .blue[박박사]
- `r icons::fontawesome$brands$github` .gray[**GITHUB**]@[mrchypark](https://github.com/mrchypark)
]]
---
## 데이터홀릭

- 2019년 4월 시작한 데이터 분야 전문 팟캐스트
- 현재 김팀장, 조과장, 박박사가 게스트를 모시고 녹음
- 팟빵 2,700여명, 유튜브 6,300여명 구독 중
- 여러 기업의 채용 방송, 게스트 방송 진행

![](https://user-images.githubusercontent.com/6179259/298201006-7f45e2a6-717c-49fc-9ecb-eec4faf52240.png)

**구독, 좋아요, 후원, 기업 강의, 채용 방송 문의등 대환영!**

<https://www.youtube.com/@dataholic4>

---

class: split-two

.column[.content.left[
.split-10[.column[
]
.column[.content[
<br>
## .green[Conalog]

### 태양광 패널별 모니터링 및 디지털 O&M 

- 패널별 모니터링을 위한 IoT 장치
- 데이터 수집을 위한 엣지 컴퓨터
- 시계열 데이터 처리와 저장
- 모니터링 대시보드

]]]]]
.column[.content.left[
<br>
<br>
<img src="https://user-images.githubusercontent.com/6179259/298209767-0fe401db-5a1e-4057-88bd-a115525a9618.png" width=90%>
]]


---

class: center, middle, title-slide

# infra as code

---

class: center, middle, title-slide


# - azure devops + azure [kubernetes]
# - github + aws [crossplane]
# - github + azure [flux]

---

# azure devops + azure


![](https://www.veritis.com/wp-content/uploads/2022/02/azure-devops-offerings.jpg)
---

# azure devops + azure

.large[
대부분의 팀이 aws를 사용 > 우리팀만 azure를 사용함

불안정한 클라우드 선택 상황 > kubernates 판단

k8s로 운영하기 어려운 storage와 database만 클라우드 사용하고 모두 k8s 사용

전체에서 운영자 혼자였기 때문에, 일을 처음부터 줄일 방법이 필요했음]

---

# kubernetes

![](https://kubernetes.io/images/docs/components-of-kubernetes.svg)

---

# kubernetes

.large[선언적 리소스 관리로 운영 비용을 줄일 수 있길 기대.

컨트롤러가 선언과 현재 상태를 확인하여 지속적으로 선언대로 되도록 만들어 줌.

확장하는 사용자 정의 컨트롤러를 작성할 수 있는데, 이를 오퍼레이터라고 함.

아무튼, 실제 도입 효과는 리소스 생성의 문제를 해결하는 피드백 루프를 제공.]
---

# 패키징 요구

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: awesome-app
  labels:
    app: awesome-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: awesome-app
  template:
    metadata:
      labels:
        app: awesome-app
    spec:
      volumes:
        - name: token-vol
          emptyDir: {}  
      initContainers:
      - name: init-dsn
        image: bitnami/bitnami-shell:latest
```

---

# 패키징 요구

.large[점점 리소스 파일이 많아지고 중복이 많아짐.

복붙은 내 친구지만 슬슬 보내줄 때가 되었음.

대표적으로 찾아바꾸기(sed) 시도

점점 찾아바꾸기로 감당이 안됨.]   


```sh
sed 's/DEPLOY_NAME/awesome-app/g'
sed 's/AWESOME_IMAGE/awesome-app-docker-image/g'
sed 's/AWESOME_IMAGE_TAG/v0.4.15/g'
```

---

class: center, middle, title-slide

![](https://velog.velcdn.com/images/yange/post/601e5fd9-7d82-41af-adf5-527b681db97f/image.png)

---

# helm

.large[k8s에서 패키징의 사실상 표준
하지만 템플릿 파일과 함께 문제를 해결하는 것이 어려움.
의존성 설계를 위해서 더 많은 것을 해야 함.]

# helmfile

.large[helm 차트의 의존성 배포를 담당.

대신 점점 배포용 value 파일이 계속 늘어나고, 명령이 중첩되면서 규모가 커짐에 따라 어려움이 많이 증가.]

---

class: center, middle, title-slide

# 내부 패키징 도구로 helm은 사용하지 말아야겠다.

---

# azure devops + cloud


.large[
연동이 매우 잘 되어 있음

비밀을 사용자가 보지도 못한다는 설계를 배움

아직 클라우드 리소스가 많지 않아서 그 부분은 수동이 가능한 정도
]

---

# github + aws

![](https://1.bp.blogspot.com/-K7rSzDdhHKo/YPwgtnnpcUI/AAAAAAAABlo/WoKcI8fa0ME749YOxWFYUDtaSCxcyklfwCLcBGAsYHQ/s720/1_ud2T-tKYh-ZM7juhyVXInw.png)

---

# github + aws

.large[github 으로 넘어오면서 비밀을 사용자가 보지도 못하게 한다는 설계를 사용할 수 없었음.

근데 IRSA라는 것이 있다는 것을 알게됨.

aws 콘솔은 참...

이걸 선언해서 사용할 방법이 필요했음.]

---

# IRSA: IAM Roles for Service Accounts

[예시코드](./demo/irsa/)

![](https://img1.daumcdn.net/thumb/R800x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FcIQoiz%2FbtrLEaRd299%2FQJr5ko3ScAhiOXZSWgUXa0%2Fimg.png)

---

# terraform

전통의 강자.
hcl이라는 자체 언어 사용
풍부하고 활발한 생태계


하지만 저에게는 hcl의 허들이 높고 이해하기 어려웠음.

---

# crossplane

클라우드 인프라의 선언적 관리를 k8s resource 와 같은 방식으로 수행해줌.

이미 k8s 가 익숙해져있는 상황에서 매우 만족스러웠음.

xrd라는 패키징도 있다고 해서 우선 도입.

---

# crossplane 구성

기본적으로 오퍼레이터임. cluster내에 배포되어 동작하면서



---

# 점점 yamler의 싹수가 보이기 시작

---

# github + azure

현재 회사의 구성

crossplane을 사용하더라도, 클라우드의 메니지드 리소스를 최대한 배제하는 방향의 설계가 필요
on-prom 설계가 고려되어야 했음.
그래서 storage 리소스만 쓰고 모두 k8s 내에서 해결 중.

모든 개발자가 일정 수준의 yaml 파일을 구성하는 것으로 인프라 관리를 할 수 있게 해야함.

push 방식의 문제점은 자동 관리되는 리소스를 코드 이외에 개입이 없도록 해야하는데, 이 부분 제어가 어려움.

---

# flux

flux는 pull 방식의 gitops를 제공하는 도구임.
push 방식에서는 그 자체의 문제는 아니지만, 상태를 들고 있는 주체가 없는 설계가 많음
그러면 클라우드에 직접 선언을 반영하고 중간에 관리하는 상태가 없어짐

pull 방식은 방식의 특성상 pull해가야 하는 주체가 항상 동작중이며, 
그 주체가 현태 상태와 같은지 확인하는 과정을 수행할 수 있음.

그래서 pull 방식의 도구 중 argoCD vs flux에서 flux를 선택하게 됨.

---

# flux

artifact를 만들 source와 controller로 구성됨.

source는 반영해야 할 선언들의 원천
controller는 그 선언을 반영하는 operator.

```yaml

```

---

# 선택한 구성

git repository
helm repository
*oci repository*
bucket
helm chart

*kustomize controller*
helm controller

---

# flux kustomization

flux가 기본 kustomize의 단점 보완해줌.

의존성

healthcheck


```yaml


```

---

